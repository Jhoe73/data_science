# Corrigindo o código para criar a tabela se ela não existir e mostrar eventos de todas as datas.

def initialize_database():
    # Conecta ao banco de dados
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    # Cria a tabela 'events' se ela não existir
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            event_type TEXT NOT NULL,
            timestamp TEXT NOT NULL
        )
    ''')
    conn.commit()
    conn.close()

def get_all_login_logout_data():
    # Conecta ao banco de dados
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    # Obtém todos os logs no banco de dados
    cursor.execute('''
        SELECT event_type, timestamp 
        FROM events 
        ORDER BY timestamp
    ''')

    events = cursor.fetchall()
    conn.close()
    return events

def create_dataframe(events):
    first_login = None
    last_logout = None
    long_intervals = []

    last_login_time = None
    records = []

    for event_type, timestamp in events:
        event_time = datetime.strptime(timestamp, "%Y-%m-%d %H:%M:%S")
        date_str = event_time.strftime("%Y-%m-%d")
        time_str = event_time.strftime("%H:%M:%S")

        if event_type == 'in':
            # Define o primeiro login se ainda não foi definido
            if first_login is None:
                first_login = event_time
                records.append({'data': date_str, 'acao': 'primeira entrada', 'hora': time_str})
            # Verifica intervalos maiores que 30 minutos
            if last_login_time and (event_time - last_login_time > timedelta(minutes=30)):
                long_intervals.append((last_login_time, event_time))
                records.append({'data': last_login_time.strftime("%Y-%m-%d"), 'acao': 'ida intervalo', 'hora': last_login_time.strftime("%H:%M:%S")})
                records.append({'data': event_time.strftime("%Y-%m-%d"), 'acao': 'volta intervalo', 'hora': time_str})
            last_login_time = event_time

        elif event_type == 'out':
            # Atualiza o último logout
            last_logout = event_time
            records.append({'data': date_str, 'acao': 'ultima saida', 'hora': time_str})

    # Cria um DataFrame com os registros
    df = pd.DataFrame(records, columns=['data', 'acao', 'hora'])
    return df

def main():
    # Inicializa o banco de dados e a tabela se necessário
    initialize_database()

    # Obtém todos os eventos
    events = get_all_login_logout_data()
    if not events:
        print("Nenhum evento de login/logout encontrado.")
        return

    df = create_dataframe(events)
    # Mostrar o DataFrame resultante
    import ace_tools as tools; tools.display_dataframe_to_user(name="Login/Logout Analysis", dataframe=df)

if __name__ == "__main__":
    main()

